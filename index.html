<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UniScan Lab Manager</title>
    
    <!-- Stili: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libreria Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- Icone -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Animazioni custom */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans min-h-screen pb-20">

    <!-- HEADER -->
    <header class="bg-indigo-700 text-white p-6 rounded-b-[2.5rem] shadow-xl sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter flex items-center gap-2">
                    <i data-lucide="scan-line" class="w-6 h-6"></i> UNISCAN
                </h1>
                <p class="text-indigo-200 text-xs font-medium uppercase tracking-widest mt-1">Lab Booking System</p>
            </div>
            <div id="user-status" class="w-3 h-3 bg-red-500 rounded-full animate-pulse" title="Stato Connessione"></div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="p-5 max-w-md mx-auto relative">
        
        <!-- SEZIONE 1: SCANNER (Default) -->
        <div id="view-scanner" class="fade-in space-y-6">
            
            <!-- Box Camera -->
            <div class="relative bg-black rounded-3xl overflow-hidden shadow-2xl aspect-square border-4 border-indigo-500/30">
                <div id="reader" class="w-full h-full object-cover"></div>
                
                <!-- Overlay "In Attesa" -->
                <div id="camera-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-white z-10">
                    <i data-lucide="camera" class="w-12 h-12 mb-4 text-indigo-400"></i>
                    <p class="font-bold">Scannerizza Strumento</p>
                    <button onclick="startScanner()" class="mt-4 px-6 py-2 bg-indigo-600 rounded-full font-bold text-sm hover:bg-indigo-500 transition">
                        AVVIA CAMERA
                    </button>
                </div>

                <!-- Overlay Laser (quando attivo) -->
                <div id="laser-line" class="hidden absolute top-1/2 left-0 w-full h-0.5 bg-red-500 shadow-[0_0_15px_red] animate-pulse z-20"></div>
                
                <button id="btn-stop" onclick="stopScanner()" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/20 backdrop-blur-md border border-white/30 text-white px-4 py-1 rounded-full text-xs font-bold z-30">
                    Chiudi
                </button>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <i data-lucide="info"></i> Istruzioni
                </h3>
                <p class="text-sm text-slate-600 leading-relaxed">
                    Inquadra il QR code o il codice a barre dello strumento per:
                    <ul class="list-disc list-inside mt-2 text-xs font-medium text-slate-500 space-y-1">
                        <li>Visualizzare la scheda tecnica / IP</li>
                        <li>Controllare la disponibilità</li>
                        <li>Effettuare una prenotazione</li>
                    </ul>
                </p>
            </div>
        </div>

        <!-- SEZIONE 2: DETTAGLIO & PRENOTAZIONE (Nascosta) -->
        <div id="view-details" class="hidden fade-in space-y-5">
            <button onclick="resetApp()" class="flex items-center gap-1 text-xs font-bold text-slate-500 hover:text-indigo-600 mb-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Torna allo Scanner
            </button>

            <!-- Card Oggetto -->
            <div class="bg-white p-5 rounded-3xl shadow-lg border-l-8 border-indigo-600 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i data-lucide="microscope" class="w-24 h-24"></i>
                </div>
                <p class="text-xs font-bold text-indigo-600 uppercase mb-1">Oggetto Rilevato</p>
                <h2 id="item-title" class="text-2xl font-black text-slate-800 break-all mb-2">---</h2>
                <div id="ip-actions" class="hidden mt-3 pt-3 border-t border-slate-100">
                    <a id="btn-open-ip" href="#" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 transition">
                        <i data-lucide="globe" class="w-4 h-4"></i> APRI INTERFACCIA WEB
                    </a>
                </div>
            </div>

            <!-- Calendario / Stato -->
            <div class="space-y-3">
                <div class="flex justify-between items-center px-2">
                    <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                        <i data-lucide="calendar-days" class="w-4 h-4"></i> Prenotazioni Future
                    </h3>
                    <button onclick="showBookingForm()" class="px-3 py-1.5 bg-emerald-500 text-white rounded-lg text-xs font-bold shadow-md hover:bg-emerald-600 transition flex items-center gap-1">
                        <i data-lucide="plus"></i> PRENOTA
                    </button>
                </div>

                <div id="bookings-list" class="space-y-2">
                    <!-- Lista prenotazioni iniettata via JS -->
                    <p class="text-center py-8 text-slate-400 text-sm italic">Caricamento disponibilità...</p>
                </div>
            </div>
        </div>

        <!-- SEZIONE 3: FORM DI PRENOTAZIONE (Modale) -->
        <div id="modal-booking" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-10">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-slate-800">Nuova Prenotazione</h3>
                    <button onclick="hideBookingForm()" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <form id="booking-form" onsubmit="handleBooking(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Nome e Cognome</label>
                        <input type="text" id="inp-name" required class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-bold" placeholder="Mario Rossi">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Motivo Utilizzo</label>
                        <select id="inp-reason" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                            <option>Manutenzione Ordinaria</option>
                            <option>Esperimento Didattico</option>
                            <option>Ricerca / Tesi</option>
                            <option>Altro</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Inizio</label>
                            <input type="datetime-local" id="inp-start" required class="w-full px-2 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Fine</label>
                            <input type="datetime-local" id="inp-end" required class="w-full px-2 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono">
                        </div>
                    </div>

                    <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-indigo-700 active:scale-95 transition mt-4">
                        CONFERMA PRENOTAZIONE
                    </button>
                </form>
            </div>
        </div>

    </main>

    <!-- FIREBASE & LOGICA APP -->
    <script type="module">
        // Importa Firebase da CDN (necessario per file HTML singolo)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- TUA CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAWbSxLJcDbB0bvd4HoMii3Z5CavR8vR-I",
          authDomain: "unisca-lab.firebaseapp.com",
          projectId: "unisca-lab",
          storageBucket: "unisca-lab.firebasestorage.app",
          messagingSenderId: "775803411857",
          appId: "1:775803411857:web:1a24be42a1c70482ad8e30",
          measurementId: "G-3ECHHPDZJZ"
        };
        
        // ID Univoco per i dati dell'app
        const appId = 'unisca-lab-v1';

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Stato Globale
        let currentUser = null;
        let currentItem = null;
        let html5QrCode = null;

        // --- AUTENTICAZIONE ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const statusEl = document.getElementById('user-status');
                if(statusEl) {
                    statusEl.classList.remove('bg-red-500', 'animate-pulse');
                    statusEl.classList.add('bg-green-500');
                    statusEl.title = "Connesso";
                }
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Errore Autenticazione:", error);
                });
            }
        });

        // --- GESTIONE INTERFACCIA ---
        window.startScanner = async () => {
            document.getElementById('camera-overlay').classList.add('hidden');
            document.getElementById('laser-line').classList.remove('hidden');
            document.getElementById('btn-stop').classList.remove('hidden');

            html5QrCode = new Html5Qrcode("reader");
            try {
                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0 
                };
                
                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    () => {} 
                );
            } catch (err) {
                alert("Impossibile avviare la fotocamera. Verifica i permessi o usa HTTPS.");
                console.error(err);
                resetApp();
            }
        };

        window.stopScanner = async () => {
            if (html5QrCode) {
                try { await html5QrCode.stop(); await html5QrCode.clear(); } catch (e) {}
                html5QrCode = null;
            }
            document.getElementById('camera-overlay').classList.remove('hidden');
            document.getElementById('laser-line').classList.add('hidden');
            document.getElementById('btn-stop').classList.add('hidden');
        };

        const onScanSuccess = (decodedText) => {
            stopScanner();
            currentItem = decodedText;
            showDetails(decodedText);
            lucide.createIcons();
        };

        // --- LOGICA DI DETTAGLIO & PRENOTAZIONI ---
        function showDetails(text) {
            document.getElementById('view-scanner').classList.add('hidden');
            document.getElementById('view-details').classList.remove('hidden');
            document.getElementById('item-title').innerText = text;
            
            // Gestione IP e Link
            const ipMatch = text.match(/(\d{1,3}\.){3}\d{1,3}/);
            const linkMatch = text.match(/https?:\/\/[^\s]+/);
            const btnIp = document.getElementById('ip-actions');
            const linkIp = document.getElementById('btn-open-ip');
            
            if (ipMatch) {
                btnIp.classList.remove('hidden');
                linkIp.href = `http://${ipMatch[0]}`;
                linkIp.innerHTML = `<i data-lucide="globe" class="w-4 h-4"></i> APRI IP: ${ipMatch[0]}`;
            } else if (linkMatch) {
                btnIp.classList.remove('hidden');
                linkIp.href = linkMatch[0];
                linkIp.innerHTML = `<i data-lucide="link" class="w-4 h-4"></i> APRI LINK`;
            } else {
                btnIp.classList.add('hidden');
            }

            loadBookings(text);
        }

        function loadBookings(itemId) {
            const listEl = document.getElementById('bookings-list');
            listEl.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600 mx-auto"></div></div>';

            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'bookings'),
                where("resourceId", "==", itemId)
            );

            onSnapshot(q, (snapshot) => {
                const bookings = [];
                snapshot.forEach(doc => bookings.push({ id: doc.id, ...doc.data() }));
                
                bookings.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

                const now = new Date();
                const yesterday = new Date(now.getTime() - 24*60*60*1000);
                const relevant = bookings.filter(b => new Date(b.endDate) > yesterday);

                renderBookingsList(relevant);
            }, (error) => {
                console.error("Errore Firestore:", error);
                listEl.innerHTML = `<p class="text-red-500 text-xs text-center">Errore caricamento dati.<br>${error.message}</p>`;
            });
        }

        function renderBookingsList(bookings) {
            const listEl = document.getElementById('bookings-list');
            if (bookings.length === 0) {
                listEl.innerHTML = `
                    <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl text-center">
                        <p class="text-emerald-600 font-bold text-sm">Strumento Libero</p>
                        <p class="text-emerald-400 text-xs">Nessuna prenotazione futura.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            bookings.forEach(b => {
                const start = new Date(b.startDate);
                const end = new Date(b.endDate);
                const now = new Date();
                const isOngoing = now >= start && now <= end;
                
                html += `
                    <div class="bg-white p-3 rounded-xl border ${isOngoing ? 'border-indigo-500 ring-2 ring-indigo-100' : 'border-slate-100'} shadow-sm flex justify-between items-center mb-2">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-black text-slate-700 uppercase">${b.userName}</span>
                                ${isOngoing ? '<span class="bg-indigo-600 text-white text-[9px] font-bold px-2 py-0.5 rounded-full">IN USO ORA</span>' : ''}
                            </div>
                            <p class="text-xs text-slate-500">
                                ${start.toLocaleDateString()} | ${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                            </p>
                            <p class="text-[10px] text-slate-400 mt-1 italic">${b.reason}</p>
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        }

        // --- GESTIONE FORM ---
        window.showBookingForm = () => {
            const now = new Date();
            const toLocalISO = (d) => {
                const offset = d.getTimezoneOffset() * 60000;
                return (new Date(d - offset)).toISOString().slice(0, 16);
            };

            const oneHourLater = new Date(now.getTime() + 60*60*1000);
            
            document.getElementById('inp-start').value = toLocalISO(now);
            document.getElementById('inp-end').value = toLocalISO(oneHourLater);
            
            document.getElementById('modal-booking').classList.remove('hidden');
        };

        window.hideBookingForm = () => {
            document.getElementById('modal-booking').classList.add('hidden');
        };

        window.handleBooking = async (e) => {
            e.preventDefault();
            if (!currentUser) return alert("Attendi connessione database...");

            const name = document.getElementById('inp-name').value;
            const reason = document.getElementById('inp-reason').value;
            const start = document.getElementById('inp-start').value;
            const end = document.getElementById('inp-end').value;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), {
                    resourceId: currentItem,
                    userName: name,
                    reason: reason,
                    startDate: start,
                    endDate: end,
                    bookedBy: currentUser.uid,
                    createdAt: serverTimestamp()
                });

                const subject = `Conferma Prenotazione Lab: ${currentItem}`;
                const body = `Ciao ${name},\n\nHai prenotato lo strumento: ${currentItem}\nMotivo: ${reason}\n\nDal: ${start.replace('T', ' ')}\nAl: ${end.replace('T', ' ')}\n\nQuesta email serve come promemoria personale.`;
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

                hideBookingForm();
                
                if(confirm("Prenotazione Salvata! Vuoi inviarti un promemoria via email?")) {
                    window.location.href = mailtoLink;
                }

            } catch (err) {
                console.error(err);
                alert("Errore salvataggio: " + err.message);
            }
        };

        window.resetApp = () => {
            document.getElementById('view-details').classList.add('hidden');
            document.getElementById('view-scanner').classList.remove('hidden');
            document.getElementById('camera-overlay').classList.remove('hidden');
            document.getElementById('laser-line').classList.add('hidden');
            document.getElementById('btn-stop').classList.add('hidden');
        };

        lucide.createIcons();
    </script>
</body>
</html>