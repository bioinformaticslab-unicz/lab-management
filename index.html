<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UniScan Lab Manager Pro v3.5</title>
    
    <!-- Stili: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libreria Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- Icone -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Grafici per Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Stili per la stampa delle etichette */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
            .label-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; page-break-inside: avoid; }
            .label-item { border: 2px solid #000; padding: 10px; text-align: center; page-break-inside: avoid; border-radius: 8px; break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen pb-24">

    <!-- HEADER & NAV (Nascosto in modalità Totem) -->
    <header id="main-header" class="bg-indigo-900 text-white p-6 rounded-b-[2rem] shadow-xl sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <div onclick="resetApp()" class="cursor-pointer">
                <h1 class="text-xl font-black italic tracking-tighter flex items-center gap-2">
                    <i data-lucide="scan-line" class="w-5 h-5"></i> UNISCAN
                </h1>
                <p class="text-indigo-200 text-[10px] font-medium uppercase tracking-widest">Lab Management v3.5</p>
            </div>
            <div class="flex gap-3">
                <button onclick="showAdminLogin()" class="p-2 bg-indigo-800 rounded-full hover:bg-indigo-700 transition" title="Admin">
                    <i data-lucide="shield" class="w-4 h-4"></i>
                </button>
                <div id="user-status" class="w-3 h-3 bg-red-500 rounded-full animate-pulse self-center" title="Stato Connessione"></div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="main-container" class="p-5 max-w-md mx-auto relative">
        
        <!-- MENU PRINCIPALE -->
        <div id="main-menu" class="flex justify-center gap-4 mb-6 fade-in">
            <button onclick="resetApp()" class="flex-1 py-3 bg-white border border-slate-200 shadow-sm rounded-xl flex flex-col items-center gap-1 active:scale-95 transition">
                <i data-lucide="qr-code" class="w-5 h-5 text-indigo-600"></i>
                <span class="text-[10px] font-bold uppercase text-slate-500">Scanner</span>
            </button>
            <button onclick="showMyBookingSearch()" class="flex-1 py-3 bg-white border border-slate-200 shadow-sm rounded-xl flex flex-col items-center gap-1 active:scale-95 transition">
                <i data-lucide="ticket" class="w-5 h-5 text-emerald-600"></i>
                <span class="text-[10px] font-bold uppercase text-slate-500">Prenotazioni</span>
            </button>
        </div>

        <!-- VISTA 1: SCANNER -->
        <div id="view-scanner" class="fade-in space-y-6">
            <div class="relative bg-black rounded-3xl overflow-hidden shadow-2xl aspect-square border-4 border-indigo-500/30">
                <div id="reader" class="w-full h-full object-cover"></div>
                <div id="camera-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-white z-10">
                    <i data-lucide="camera" class="w-12 h-12 mb-4 text-indigo-400"></i>
                    <p class="font-bold">Scannerizza Strumento</p>
                    <button onclick="startScanner()" class="mt-4 px-6 py-2 bg-indigo-600 rounded-full font-bold text-sm hover:bg-indigo-500 transition shadow-lg shadow-indigo-500/50">
                        AVVIA CAMERA
                    </button>
                </div>
                <div id="laser-line" class="hidden absolute top-1/2 left-0 w-full h-0.5 bg-red-500 shadow-[0_0_15px_red] animate-pulse z-20"></div>
                <button id="btn-stop" onclick="stopScanner()" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/20 backdrop-blur-md border border-white/30 text-white px-4 py-1 rounded-full text-xs font-bold z-30">Chiudi</button>
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="inp-manual-code" placeholder="Inserisci codice manuale (es. 1.1.1.1)" class="flex-1 px-4 py-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-mono shadow-sm">
                <button onclick="manualSearch()" class="px-4 py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg hover:bg-slate-700 transition flex items-center justify-center">
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl text-center">
                <p class="text-xs text-indigo-800 font-medium">Usa lo scanner o inserisci l'ID. Abilita le notifiche per promemoria automatici.</p>
                <button onclick="requestNotificationPermission()" class="mt-2 text-[10px] underline text-indigo-600 font-bold">Attiva Notifiche Browser</button>
            </div>
        </div>

        <!-- VISTA 2: DETTAGLIO STRUMENTO -->
        <div id="view-details" class="hidden fade-in space-y-5">
            <div class="bg-white p-5 rounded-3xl shadow-lg border-l-8 border-indigo-600 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i data-lucide="microscope" class="w-24 h-24"></i>
                </div>
                <div class="flex justify-between items-start">
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-1">
                            <p class="text-xs font-bold text-indigo-600 uppercase">Oggetto Rilevato</p>
                            <span id="badge-status" class="hidden text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-black uppercase">SOLO CONSULTAZIONE</span>
                        </div>
                        <h2 id="item-title" class="text-2xl font-black text-slate-800 break-all leading-tight">---</h2>
                        <p id="item-subtitle" class="text-sm font-mono text-slate-400 mt-1">ID: ---</p>
                    </div>
                    <button onclick="reportIssue()" class="text-amber-500 p-2 hover:bg-amber-50 rounded-full relative z-10" title="Segnala Guasto">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div id="ip-actions" class="hidden mt-3 pt-3 border-t border-slate-100 flex flex-wrap gap-2 relative z-10">
                    <a id="btn-open-ip" href="#" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 transition">
                        <i data-lucide="globe" class="w-4 h-4"></i> APRI IP
                    </a>
                </div>
                
                <div class="mt-4 pt-2 border-t border-slate-50 relative z-10">
                     <button onclick="copyDirectLink()" class="flex items-center gap-1 text-[10px] text-slate-400 hover:text-indigo-600">
                        <i data-lucide="link" class="w-3 h-3"></i> Copia Link Prenotazione
                     </button>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center px-2">
                    <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                        <i data-lucide="calendar-days" class="w-4 h-4"></i> Stato e Prenotazioni
                    </h3>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="openCalendarModal()" class="flex-1 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-xs font-bold shadow-sm hover:bg-slate-50 transition flex items-center justify-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4"></i> Disponibilità
                    </button>
                    <button id="btn-main-book" onclick="showBookingForm()" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl text-xs font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-600 transition flex items-center justify-center gap-2">
                        <i data-lucide="plus"></i> PRENOTA
                    </button>
                </div>

                <div id="bookings-list" class="space-y-2 pb-10"></div>
            </div>
        </div>

        <!-- VISTA 3: ADMIN PANEL -->
        <div id="view-admin" class="hidden fade-in space-y-4">
            <h2 class="text-lg font-black text-slate-800 flex items-center gap-2 border-b pb-2">
                <i data-lucide="layout-dashboard" class="w-5 h-5 text-indigo-600"></i> Dashboard
            </h2>
            
            <div class="flex gap-1 text-xs font-bold bg-slate-200 p-1 rounded-lg overflow-x-auto no-scrollbar">
                <button onclick="switchAdminTab('bookings')" id="tab-btn-bookings" class="flex-1 py-2 px-3 bg-white text-indigo-700 rounded-md shadow-sm transition whitespace-nowrap">Prenotazioni</button>
                <button onclick="switchAdminTab('instruments')" id="tab-btn-instruments" class="flex-1 py-2 px-3 text-slate-500 hover:bg-white/50 rounded-md transition whitespace-nowrap">Strumenti</button>
                <button onclick="switchAdminTab('analytics')" id="tab-btn-analytics" class="flex-1 py-2 px-3 text-slate-500 hover:bg-white/50 rounded-md transition whitespace-nowrap">Analytics</button>
                <button onclick="switchAdminTab('audit')" id="tab-btn-audit" class="flex-1 py-2 px-3 text-slate-500 hover:bg-white/50 rounded-md transition whitespace-nowrap">Audit</button>
                <button onclick="switchAdminTab('settings')" id="tab-btn-settings" class="flex-1 py-2 px-3 text-slate-500 hover:bg-white/50 rounded-md transition whitespace-nowrap">Settings</button>
            </div>

            <!-- Tab: Prenotazioni -->
            <div id="admin-content-bookings" class="space-y-3">
                <button onclick="exportBookingsCSV()" class="w-full py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold shadow flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> SCARICA CSV
                </button>
                <div id="admin-list" class="space-y-3"></div>
            </div>

            <!-- Tab: Strumenti & Etichette -->
            <div id="admin-content-instruments" class="hidden space-y-4">
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2"><i data-lucide="settings-2" class="w-4 h-4"></i> Configura</h3>
                        <button onclick="clearInstrumentForm()" class="text-[10px] text-indigo-600 font-bold hover:underline">NUOVO / PULISCI</button>
                    </div>
                    <form onsubmit="saveInstrument(event)" class="space-y-3">
                        <div>
                            <label class="block text-[10px] text-slate-500 font-bold uppercase mb-1">Codice ID (1.1.1.1)</label>
                            <input type="text" id="inp-inst-id" required class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 font-bold uppercase mb-1">Nome Strumento</label>
                            <input type="text" id="inp-inst-desc" required class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 font-bold uppercase mb-1">Referente / Contatto</label>
                            <input type="text" id="inp-inst-contact" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs" placeholder="Es: Prof. Rossi (rossi@uni.it)">
                        </div>
                        <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <input type="checkbox" id="inp-inst-bookable" class="h-4 w-4 rounded border-slate-300 text-indigo-600" checked>
                            <label for="inp-inst-bookable" class="text-xs font-bold text-slate-700">Prenotabile</label>
                        </div>
                        <button type="submit" class="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold text-xs">SALVA MODIFICHE</button>
                    </form>
                </div>
                
                <div class="flex justify-between items-center mt-4 px-1">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">Lista & Etichette</h3>
                    <button onclick="printLabels()" class="text-xs bg-slate-800 text-white px-3 py-1 rounded flex items-center gap-1"><i data-lucide="printer" class="w-3 h-3"></i> STAMPA QR</button>
                </div>
                <div id="instruments-list" class="space-y-2"></div>
            </div>

            <!-- Tab: Analytics -->
            <div id="admin-content-analytics" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Totale Prenotazioni</p>
                        <p id="stat-total-bookings" class="text-2xl font-black text-indigo-600">0</p>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Strumenti Attivi</p>
                        <p id="stat-total-instruments" class="text-2xl font-black text-emerald-600">0</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <h4 class="text-xs font-bold text-slate-700 mb-2">Utilizzo Strumenti (Top 5)</h4>
                    <canvas id="chart-instruments" height="200"></canvas>
                </div>
            </div>

            <!-- Tab: Audit Log -->
            <div id="admin-content-audit" class="hidden space-y-3">
                <div id="audit-list" class="space-y-2 text-xs">
                    <p class="text-center text-slate-400">Caricamento log...</p>
                </div>
            </div>

            <!-- Tab: Impostazioni (CON LINK TOTEM) -->
            <div id="admin-content-settings" class="hidden space-y-4">
                <div class="bg-amber-50 p-4 rounded-xl border border-amber-200 shadow-sm">
                    <h3 class="text-sm font-bold text-amber-800 mb-2 flex items-center gap-2"><i data-lucide="cone" class="w-4 h-4"></i> Manutenzione</h3>
                    <div class="flex items-center gap-3 bg-white p-3 rounded-lg border border-amber-100 mb-3">
                        <input type="checkbox" id="inp-maint-active" class="h-5 w-5 text-red-600 rounded">
                        <label for="inp-maint-active" class="text-xs font-black text-slate-700">ATTIVA MODALITÀ MANUTENZIONE</label>
                    </div>
                    <input type="text" id="inp-maint-name" class="w-full mb-2 px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs" placeholder="Nome Referente">
                    <input type="email" id="inp-maint-email" class="w-full mb-2 px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs" placeholder="Email Referente">
                    <button onclick="saveGlobalSettings()" class="w-full py-2 bg-slate-800 text-white rounded-lg font-bold text-xs">AGGIORNA</button>
                </div>

                <!-- SEZIONE TOTEM -->
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200 shadow-sm">
                    <h3 class="text-sm font-bold text-indigo-800 mb-2 flex items-center gap-2"><i data-lucide="monitor" class="w-4 h-4"></i> Modalità Totem</h3>
                    <p class="text-[10px] text-indigo-700 mb-3">Dashboard automatica per display a parete e tablet fissi. Mostra lo stato del lab in tempo reale.</p>
                    <a href="?mode=totem" target="_blank" class="block w-full py-3 bg-indigo-600 text-white rounded-lg font-bold text-xs text-center shadow hover:bg-indigo-700 transition">
                        APRI DASHBOARD TOTEM
                    </a>
                </div>
            </div>
        </div>

        <!-- VISTA 4: RICERCA -->
        <div id="view-my-booking" class="hidden fade-in flex flex-col items-center justify-center py-10 space-y-4">
            <h2 class="text-lg font-bold text-slate-800 text-center">Gestione Prenotazione</h2>
            <input type="text" id="inp-pnr-search" placeholder="Codice PNR (es: X7K9P2)" class="w-full max-w-xs text-center text-xl font-mono uppercase px-4 py-3 border-2 border-slate-200 rounded-xl">
            <button onclick="searchBookingByPNR()" class="w-full max-w-xs py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg">CERCA</button>
            <div id="pnr-result" class="w-full max-w-xs mt-6"></div>
        </div>

    </main>

    <!-- VISTA 5: TOTEM (Nuova) -->
    <div id="view-totem" class="hidden fixed inset-0 bg-slate-900 text-white z-[100] overflow-hidden flex flex-col p-6">
        <!-- Header Totem -->
        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
            <h1 class="text-3xl font-black italic tracking-tighter flex items-center gap-3">
                <i data-lucide="monitor" class="w-8 h-8 text-emerald-400"></i> UNISCAN LIVE
            </h1>
            <div class="text-right">
                <div id="totem-clock" class="text-4xl font-mono font-bold text-slate-200">00:00</div>
                <div id="totem-date" class="text-sm text-slate-400 font-medium uppercase tracking-widest">---</div>
            </div>
        </div>
    
        <div class="flex gap-8 flex-1 overflow-hidden">
            <!-- Colonna: In Corso -->
            <div class="w-1/2 flex flex-col gap-4">
                <h2 class="text-xl font-bold text-emerald-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                    <span class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_10px_#10b981]"></span> In Corso Ora
                </h2>
                <div id="totem-active-list" class="space-y-3 overflow-y-auto no-scrollbar pr-2">
                    <p class="text-slate-500 italic text-sm">Nessuna attività in corso.</p>
                </div>
            </div>
    
            <!-- Colonna: Prossime -->
            <div class="w-1/2 flex flex-col gap-4 border-l border-slate-700 pl-8">
                <h2 class="text-xl font-bold text-indigo-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                    <i data-lucide="clock" class="w-5 h-5"></i> Prossime
                </h2>
                <div id="totem-upcoming-list" class="space-y-3 overflow-y-auto no-scrollbar pr-2">
                    <p class="text-slate-500 italic text-sm">Nessuna prenotazione futura.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AREA STAMPA NASCOSTA -->
    <div id="print-area" class="hidden bg-white p-5">
        <h1 class="text-2xl font-bold mb-2 text-center">Etichette Strumenti UniScan</h1>
        <p class="text-center text-sm mb-5">Generato il: <span id="print-date"></span></p>
        <div id="print-grid" class="label-grid"></div>
        <div class="mt-10 text-center no-print">
            <button onclick="document.getElementById('print-area').classList.add('hidden')" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold">CHIUDI ANTEPRIMA</button>
        </div>
    </div>

    <!-- OVERLAY MANUTENZIONE -->
    <div id="view-maintenance" class="hidden fixed inset-0 bg-slate-50 z-[60] flex flex-col items-center justify-center p-6 text-center animate-in fade-in">
        <div class="w-20 h-20 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mb-6">
            <i data-lucide="cone" class="w-10 h-10"></i>
        </div>
        <h1 class="text-2xl font-black text-slate-800 mb-2">Manutenzione in Corso</h1>
        <p class="text-slate-500 mb-8 max-w-xs mx-auto text-sm">Il sistema è temporaneamente sospeso.</p>
        <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200 w-full max-w-sm">
            <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Referente</p>
            <p id="maint-ref-name" class="font-bold text-slate-800 mb-4">---</p>
            <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Email</p>
            <a id="maint-ref-email" href="#" class="font-bold text-indigo-600 underline">---</a>
        </div>
        <button onclick="showAdminLogin()" class="absolute bottom-8 text-slate-400 hover:text-slate-600 text-[10px] font-bold flex items-center gap-1">
            <i data-lucide="lock" class="w-3 h-3"></i> ADMIN UNLOCK
        </button>
    </div>

    <!-- MODALI (Booking & Calendar) -->
    <div id="modal-booking" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-10 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-lg font-bold text-slate-800">Prenotazione</h3>
                <button onclick="hideBookingForm()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <form id="booking-form" onsubmit="handleBooking(event)" class="space-y-4 flex-1 overflow-y-auto no-scrollbar">
                <input type="text" id="inp-name" required class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold" placeholder="Nome Cognome">
                <select id="inp-reason" onchange="toggleCustomReason()" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                    <option value="Manutenzione Ordinaria">Manutenzione Ordinaria</option>
                    <option value="Esperimento Didattico">Esperimento Didattico</option>
                    <option value="Ricerca / Tesi">Ricerca / Tesi</option>
                    <option value="Altro">Altro</option>
                </select>
                <input type="text" id="inp-reason-custom" class="hidden w-full mt-2 px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="Specifica motivo...">
                <div class="grid grid-cols-2 gap-3">
                    <input type="datetime-local" id="inp-start" required class="w-full px-2 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono">
                    <input type="datetime-local" id="inp-end" required class="w-full px-2 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono">
                </div>
                <button id="btn-submit-booking" type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg">CONFERMA</button>
            </form>
            
            <!-- FOOTER INFORMATIVO (NUOVO) -->
            <div class="mt-4 pt-4 border-t border-slate-100 bg-slate-50 -mx-6 -mb-6 p-4 rounded-b-3xl">
                <div class="flex gap-2 items-start mb-2">
                    <i data-lucide="info" class="w-4 h-4 text-indigo-500 mt-0.5 shrink-0"></i>
                    <p class="text-[10px] text-slate-500 leading-tight">
                        <strong>Istruzioni:</strong> Usa questo form per prenotare. Salva il codice <strong>PNR</strong> che riceverai per modificare o cancellare la prenotazione in seguito.
                    </p>
                </div>
                <div class="flex gap-2 items-start">
                    <i data-lucide="user-circle" class="w-4 h-4 text-emerald-600 mt-0.5 shrink-0"></i>
                    <div>
                        <p class="text-[10px] font-bold text-slate-700 uppercase">Referente Macchina</p>
                        <p id="booking-contact-info" class="text-xs text-slate-800 font-medium">---</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-calendar" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-10 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">Disponibilità 7gg</h3>
                <button onclick="document.getElementById('modal-calendar').classList.add('hidden')" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <!-- Added Action Button for Admin -->
            <div id="calendar-admin-actions" class="hidden mb-3">
                <button onclick="document.getElementById('modal-calendar').classList.add('hidden'); showBookingForm()" class="w-full py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold flex items-center justify-center gap-2">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> NUOVA PRENOTAZIONE (ADMIN)
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto no-scrollbar space-y-4" id="calendar-container"></div>
        </div>
    </div>

    <!-- LOGICA APP -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, updateDoc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
          apiKey: "AIzaSyAWbSxLJcDbB0bvd4HoMii3Z5CavR8vR-I",
          authDomain: "unisca-lab.firebaseapp.com",
          projectId: "unisca-lab",
          storageBucket: "unisca-lab.firebasestorage.app",
          messagingSenderId: "775803411857",
          appId: "1:775803411857:web:1a24be42a1c70482ad8e30",
          measurementId: "G-3ECHHPDZJZ"
        };
        const appId = 'unisca-lab-v1';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentItem = null; 
        let currentItemName = null;
        let html5QrCode = null;
        let adminMode = false;
        let editingBookingId = null;
        window.currentFoundBooking = null;
        window.calendarBookingsCache = [];
        window.adminBookingsCache = [];
        window.allInstrumentsCache = []; 
        window.currentInstrumentData = {}; // Stores details of current viewed instrument

        // AUTH
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userStatus = document.getElementById('user-status');
                if(userStatus) {
                    userStatus.classList.remove('bg-red-500', 'animate-pulse');
                    userStatus.classList.add('bg-green-500');
                }
                
                checkUrlParams(); // Check TOTEM or Deep Link
                initNotifications(); 
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        // --- URL & TOTEM LOGIC ---
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const resourceId = urlParams.get('r');

            if (mode === 'totem') {
                initTotemMode();
            } else {
                loadGlobalSettings(); // Load normal settings only if not totem (or load inside)
                if (resourceId) {
                    currentItem = resourceId;
                    showDetails(resourceId);
                }
            }
        }

        // --- TOTEM MODE FUNCTIONS ---
        function initTotemMode() {
            // Nascondi tutto tranne view-totem
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('main-container').classList.add('hidden');
            document.getElementById('view-totem').classList.remove('hidden');
            
            // Orologio
            setInterval(updateTotemClock, 1000);
            updateTotemClock();

            // Data Listener
            loadTotemData();
        }

        function updateTotemClock() {
            const now = new Date();
            document.getElementById('totem-clock').innerText = now.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('totem-date').innerText = now.toLocaleDateString('it-IT', {weekday:'long', day:'numeric', month:'long'});
        }

        function loadTotemData() {
            // Query per prendere prenotazioni recenti/future (es. ultime 2h e future)
            // Limitiamo la query per performance in un app reale, qui prendiamo tutto e filtriamo
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'));
            
            onSnapshot(q, (snapshot) => {
                const bookings = [];
                snapshot.forEach(doc => bookings.push({ id: doc.id, ...doc.data() }));
                
                const now = new Date();
                
                // Filtro Attivi
                const active = bookings.filter(b => {
                    const start = new Date(b.startDate);
                    const end = new Date(b.endDate);
                    return now >= start && now <= end;
                });

                // Filtro Prossimi (prossime 24h)
                const upcoming = bookings.filter(b => {
                    const start = new Date(b.startDate);
                    return start > now && start < new Date(now.getTime() + 86400000);
                }).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));

                renderTotemLists(active, upcoming);
            });
        }

        function renderTotemLists(active, upcoming) {
            const activeContainer = document.getElementById('totem-active-list');
            const upcomingContainer = document.getElementById('totem-upcoming-list');

            if (active.length === 0) {
                activeContainer.innerHTML = `<p class="text-slate-500 italic text-lg mt-4">Nessuno strumento in uso al momento.</p>`;
            } else {
                activeContainer.innerHTML = active.map(b => `
                    <div class="bg-slate-800 p-4 rounded-xl border-l-4 border-emerald-500 shadow-lg">
                        <h3 class="text-xl font-bold text-white mb-1">${b.resourceName || b.resourceId}</h3>
                        <p class="text-emerald-400 font-bold text-lg uppercase mb-1">${b.userName}</p>
                        <p class="text-slate-400 text-sm flex items-center gap-2">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                            Termina alle: <span class="text-white font-mono">${new Date(b.endDate).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            del <span class="text-white font-mono">${new Date(b.endDate).toLocaleDateString('it-IT')}</span>
                        </p>
                    </div>
                `).join('');
            }

            if (upcoming.length === 0) {
                upcomingContainer.innerHTML = `<p class="text-slate-500 italic text-sm">Nessuna prenotazione in programma oggi.</p>`;
            } else {
                upcomingContainer.innerHTML = upcoming.map(b => `
                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700 flex justify-between items-center">
                        <div>
                            <p class="text-white font-bold text-sm">${b.resourceName || b.resourceId}</p>
                            <p class="text-indigo-300 text-xs uppercase">${b.userName}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-white font-mono font-bold text-lg">${new Date(b.startDate).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                            <p class="text-slate-500 text-[10px]">INIZIO</p>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        // --- ALTRE FUNZIONI ESISTENTI (Export, Audit, etc) ---
        window.exportBookingsCSV = () => {
            const bookings = window.adminBookingsCache;
            if (!bookings || bookings.length === 0) return alert("Nessun dato.");
            const headers = ["ID", "Nome", "Utente", "Motivo", "Inizio", "Fine", "PNR", "Data"];
            const rows = bookings.map(b => [
                b.resourceId, b.resourceName || '', b.userName, b.reason, b.startDate, b.endDate, b.pnr || '',
                b.createdAt ? new Date(b.createdAt.seconds * 1000).toLocaleString() : ''
            ]);
            const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `report_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- IDEA 8: AUDIT LOG SYSTEM ---
        async function logAudit(action, details) {
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'audit_logs'), {
                    action: action,
                    details: details,
                    user: currentUser ? currentUser.uid : 'anon',
                    timestamp: serverTimestamp()
                });
            } catch(e) { console.error("Audit log failed", e); }
        }

        window.loadAuditLogs = () => {
            const listEl = document.getElementById('audit-list');
            listEl.innerHTML = '<p class="text-center text-slate-400">Caricamento...</p>';
            let q = query(collection(db, 'artifacts', appId, 'public', 'data', 'audit_logs'), orderBy('timestamp', 'desc')); 
            
            onSnapshot(q, (snapshot) => {
                const logs = [];
                snapshot.forEach(doc => logs.push(doc.data()));
                listEl.innerHTML = logs.map(l => `
                    <div class="bg-white p-2 border-b border-slate-100 flex justify-between items-center">
                        <div>
                            <span class="font-bold text-indigo-700 uppercase text-[10px]">${l.action}</span>
                            <p class="text-slate-600">${l.details}</p>
                        </div>
                        <span class="text-[9px] text-slate-400 font-mono">
                            ${l.timestamp ? new Date(l.timestamp.seconds * 1000).toLocaleString() : ''}
                        </span>
                    </div>
                `).join('');
            }, (error) => {
                // Fallback sort
                const qFallback = query(collection(db, 'artifacts', appId, 'public', 'data', 'audit_logs'));
                onSnapshot(qFallback, (snapshot) => {
                    const logs = [];
                    snapshot.forEach(doc => logs.push(doc.data()));
                    logs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    listEl.innerHTML = logs.map(l => `
                        <div class="bg-white p-2 border-b border-slate-100 flex justify-between items-center">
                            <div>
                                <span class="font-bold text-indigo-700 uppercase text-[10px]">${l.action}</span>
                                <p class="text-slate-600">${l.details}</p>
                            </div>
                            <span class="text-[9px] text-slate-400 font-mono">
                                ${l.timestamp ? new Date(l.timestamp.seconds * 1000).toLocaleString() : ''}
                            </span>
                        </div>
                    `).join('');
                });
            });
        };

        // --- IDEA 10: ANALYTICS ---
        window.loadAnalytics = () => {
            const bookings = window.adminBookingsCache; 
            if(!bookings || bookings.length === 0) return;

            document.getElementById('stat-total-bookings').innerText = bookings.length;
            document.getElementById('stat-total-instruments').innerText = window.allInstrumentsCache.length;

            const counts = {};
            bookings.forEach(b => {
                const name = b.resourceName || b.resourceId;
                counts[name] = (counts[name] || 0) + 1;
            });
            
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            
            const ctx = document.getElementById('chart-instruments').getContext('2d');
            if(window.myChart) window.myChart.destroy(); 
            
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(i => i[0]),
                    datasets: [{
                        label: 'Prenotazioni',
                        data: sorted.map(i => i[1]),
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        };

        // --- IDEA 7: LABEL GENERATOR (UPDATED) ---
        window.printLabels = () => {
            if(window.allInstrumentsCache.length === 0) return alert("Nessuno strumento da stampare.");
            
            const container = document.getElementById('print-grid');
            const printArea = document.getElementById('print-area');
            container.innerHTML = '';
            document.getElementById('print-date').innerText = new Date().toLocaleDateString();
            
            let loadedCount = 0;
            const total = window.allInstrumentsCache.length;
            printArea.classList.remove('hidden');

            window.allInstrumentsCache.forEach(inst => {
                const url = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(inst.id)}`;
                const item = document.createElement('div');
                item.className = 'label-item';
                
                const img = new Image();
                img.src = url;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.display = 'block';
                img.style.margin = '0 auto';
                
                img.onload = () => {
                    loadedCount++;
                    if(loadedCount === total) setTimeout(() => window.print(), 500);
                };
                
                item.innerHTML = `<h3 style="font-size:14px; font-weight:bold; margin-bottom:5px;">${inst.description}</h3>`;
                item.appendChild(img);
                item.innerHTML += `
                    <p style="font-family:sans-serif; font-size:10px; font-weight:bold; margin-top:5px; color:#444;">SCANSIONA PER PRENOTARE</p>
                    <p style="font-family:monospace; font-size:10px; margin-top:2px;">${inst.id}</p>
                `;
                container.appendChild(item);
            });
        };

        // --- IDEA 9: NOTIFICATIONS ---
        function initNotifications() {
            if (!("Notification" in window)) return;
            setInterval(checkUpcomingBookings, 60000);
        }

        window.requestNotificationPermission = () => {
            Notification.requestPermission().then(permission => {
                if(permission === "granted") alert("Notifiche attivate!");
            });
        };

        function checkUpcomingBookings() {
            if (Notification.permission !== "granted") return;
        }

        // --- CORE FUNCTIONS ---
        window.saveInstrument = async (e) => {
            e.preventDefault();
            const id = document.getElementById('inp-inst-id').value.trim();
            const desc = document.getElementById('inp-inst-desc').value.trim();
            const contact = document.getElementById('inp-inst-contact').value.trim(); // NEW
            const bookable = document.getElementById('inp-inst-bookable').checked;
            
            if(!id || !desc) return alert("Compila tutto");
            try {
                const safeId = id.replace(/\//g, '_');
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'resources', safeId), {
                    id: id, 
                    description: desc, 
                    contact: contact, // NEW
                    isBookable: bookable, 
                    updatedAt: serverTimestamp()
                });
                logAudit("UPDATE_INSTRUMENT", `Updated instrument: ${desc} (${id})`);
                alert("Salvato!");
                clearInstrumentForm(); 
            } catch(e) { alert(e.message); }
        };
        
        window.clearInstrumentForm = () => {
            document.getElementById('inp-inst-id').value = '';
            document.getElementById('inp-inst-desc').value = '';
            document.getElementById('inp-inst-contact').value = ''; // NEW
            document.getElementById('inp-inst-bookable').checked = true;
            document.getElementById('inp-inst-id').readOnly = false; 
            document.getElementById('inp-inst-id').classList.remove('bg-slate-100', 'text-slate-500');
        };
        
        window.editInstrument = (id) => {
            const inst = window.allInstrumentsCache.find(i => i.id === id);
            if(!inst) return;
            document.getElementById('inp-inst-id').value = inst.id;
            document.getElementById('inp-inst-desc').value = inst.description;
            document.getElementById('inp-inst-contact').value = inst.contact || ''; // NEW
            document.getElementById('inp-inst-bookable').checked = inst.isBookable !== false;
            document.getElementById('admin-content-instruments').scrollIntoView({ behavior: 'smooth' });
            const idField = document.getElementById('inp-inst-id');
            idField.readOnly = true;
            idField.classList.add('bg-slate-100', 'text-slate-500');
        };

        window.handleBooking = async (e) => {
            e.preventDefault();
            if (!currentUser) return alert("No connection");
            const name = document.getElementById('inp-name').value;
            let reason = document.getElementById('inp-reason').value;
            if(reason === 'Altro') reason = document.getElementById('inp-reason-custom').value;
            const start = document.getElementById('inp-start').value;
            const end = document.getElementById('inp-end').value;

            try {
                if(editingBookingId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', editingBookingId), {
                        userName: name, reason: reason, startDate: start, endDate: end, updatedAt: serverTimestamp()
                    });
                    logAudit("MODIFY_BOOKING", `Modified booking for ${name}`);
                    alert("Modificata!");
                } else {
                    const pnr = Math.random().toString(36).substring(2, 8).toUpperCase();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), {
                        resourceId: currentItem || 'Manual', 
                        resourceName: currentItemName || currentItem,
                        userName: name, reason: reason, startDate: start, endDate: end, pnr: pnr, bookedBy: currentUser.uid, createdAt: serverTimestamp()
                    });
                    logAudit("NEW_BOOKING", `New booking: ${currentItem} by ${name} [${pnr}]`);
                    alert(`Confermata! PNR: ${pnr}`);
                    window.location.href = `mailto:?subject=Prenotazione ${currentItem}&body=PNR:${pnr}`;
                }
                hideBookingForm();
            } catch(e) { alert(e.message); }
        };

        window.deleteBooking = async (id) => {
            if(confirm("Eliminare?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', id));
                    logAudit("DELETE_BOOKING", `Deleted booking ID: ${id}`);
                } catch(e) { alert(e.message); }
            }
        };

        window.saveGlobalSettings = async () => {
            const isActive = document.getElementById('inp-maint-active').checked;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), {
                    maintenanceMode: isActive,
                    referentName: document.getElementById('inp-maint-name').value,
                    referentEmail: document.getElementById('inp-maint-email').value,
                    updatedAt: serverTimestamp()
                });
                logAudit("MAINTENANCE_TOGGLE", `Maintenance set to: ${isActive}`);
                alert("Impostazioni salvate.");
            } catch(e) { alert(e.message); }
        };

        // --- ADMIN TABS ---
        window.switchAdminTab = (tab) => {
            ['bookings', 'instruments', 'analytics', 'audit', 'settings'].forEach(t => {
                document.getElementById('admin-content-' + t).classList.add('hidden');
                document.getElementById('tab-btn-' + t).classList.remove('bg-white', 'text-indigo-700', 'shadow-sm');
                document.getElementById('tab-btn-' + t).classList.add('text-slate-500');
            });
            document.getElementById('admin-content-' + tab).classList.remove('hidden');
            document.getElementById('tab-btn-' + tab).classList.add('bg-white', 'text-indigo-700', 'shadow-sm');
            document.getElementById('tab-btn-' + tab).classList.remove('text-slate-500');

            if(tab === 'bookings') loadAdminBookings();
            if(tab === 'instruments') loadInstruments();
            if(tab === 'audit') loadAuditLogs();
            if(tab === 'analytics') loadAnalytics();
        };

        window.loadInstruments = () => {
            const listEl = document.getElementById('instruments-list');
            listEl.innerHTML = '<p class="text-center text-xs">Caricamento...</p>';
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'resources'));
            onSnapshot(q, (snapshot) => {
                const items = [];
                snapshot.forEach(doc => items.push(doc.data()));
                window.allInstrumentsCache = items; 
                
                listEl.innerHTML = items.map(item => `
                    <div class="bg-white p-3 rounded-lg border border-slate-100 flex justify-between items-center shadow-sm">
                        <div>
                            <div class="text-xs font-bold text-slate-700">${item.description}</div>
                            <div class="text-[10px] text-slate-400 font-mono">${item.id}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openCalendarForInstrument('${item.id}', '${item.description}')" class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100" title="Calendario">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                            </button>
                            <button onclick="editInstrument('${item.id}')" class="p-2 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200 transition" title="Modifica">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            });
        };

        // --- STANDARD FUNCTIONS ---
        window.resetApp = () => {
            window.switchView('view-scanner');
            document.getElementById('camera-overlay').classList.remove('hidden');
            document.getElementById('btn-stop').classList.add('hidden');
            loadGlobalSettings();
        };
        window.switchView = (id) => {
            ['view-scanner', 'view-details', 'view-admin', 'view-my-booking'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };
        window.showAdminLogin = () => {
            if(prompt("PIN Admin:") === "1234") {
                adminMode = true;
                document.getElementById('view-maintenance').classList.add('hidden');
                window.switchView('view-admin');
                switchAdminTab('bookings');
            }
        };
        
        function loadGlobalSettings() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), (doc) => {
                if(doc.exists()) {
                    const d = doc.data();
                    if(d.maintenanceMode && !adminMode) document.getElementById('view-maintenance').classList.remove('hidden');
                    else document.getElementById('view-maintenance').classList.add('hidden');
                    
                    document.getElementById('inp-maint-active').checked = d.maintenanceMode;
                    document.getElementById('inp-maint-name').value = d.referentName || '';
                    document.getElementById('inp-maint-email').value = d.referentEmail || '';
                    document.getElementById('maint-ref-name').innerText = d.referentName || 'Segreteria';
                    document.getElementById('maint-ref-email').innerText = d.referentEmail || 'Email';
                    document.getElementById('maint-ref-email').href = `mailto:${d.referentEmail}`;
                }
            });
        }
        
        window.showBookingForm = () => { 
            editingBookingId = null; 
            document.getElementById('modal-booking').classList.remove('hidden'); 
            updateBookingFooter(); // Aggiorna il footer con il referente corrente
        };
        
        function updateBookingFooter() {
            const info = window.currentInstrumentData?.contact || "Referente non assegnato";
            document.getElementById('booking-contact-info').innerText = info;
        }

        window.hideBookingForm = () => document.getElementById('modal-booking').classList.add('hidden');
        window.toggleCustomReason = () => {
            const v = document.getElementById('inp-reason').value;
            document.getElementById('inp-reason-custom').classList.toggle('hidden', v !== 'Altro');
        };
        window.manualSearch = () => {
            const c = document.getElementById('inp-manual-code').value;
            if(c) { currentItem = c; showDetails(c); }
        };
        window.showMyBookingSearch = () => window.switchView('view-my-booking');
        window.searchBookingByPNR = () => { 
            const pnr = document.getElementById('inp-pnr-search').value.trim().toUpperCase();
            const resDiv = document.getElementById('pnr-result');
            if(pnr.length < 3) return alert("Inserisci un codice valido");
            resDiv.innerHTML = '<p class="text-center text-xs">Ricerca...</p>';
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), where("pnr", "==", pnr));
            onSnapshot(q, (snapshot) => {
                if(snapshot.empty) {
                    resDiv.innerHTML = '<p class="text-center text-red-500 font-bold text-sm">Nessuna prenotazione trovata.</p>';
                    return;
                }
                const b = snapshot.docs[0].data();
                b.id = snapshot.docs[0].id;
                window.currentFoundBooking = b; 
                resDiv.innerHTML = `
                    <div class="bg-white p-4 rounded-xl border-2 border-emerald-500 shadow-xl animate-in fade-in slide-in-from-bottom-5">
                        <h3 class="text-sm font-bold text-emerald-700 uppercase mb-2">Prenotazione Trovata</h3>
                        <p class="text-xs text-slate-500">Strumento:</p>
                        <p class="font-bold text-slate-800 mb-2">${b.resourceName || b.resourceId}</p>
                        <p class="text-xs text-slate-500">Orario:</p>
                        <p class="font-mono text-xs text-slate-700 mb-4 bg-slate-100 p-2 rounded">${b.startDate}<br>al ${b.endDate}</p>
                        <div class="flex gap-2">
                            <button onclick="openEditModal()" class="flex-1 py-2 bg-amber-400 text-amber-900 rounded-lg font-bold text-xs shadow hover:bg-amber-500 transition">MODIFICA</button>
                            <button onclick="deleteBooking('${b.id}')" class="flex-1 py-2 bg-red-500 text-white rounded-lg font-bold text-xs shadow hover:bg-red-600 transition">CANCELLA</button>
                        </div>
                    </div>
                `;
            });
        };
        
        async function showDetails(text) {
            window.switchView('view-details');
            document.getElementById('item-title').innerText = text;
            
            // Fix: Reset UI state first
            document.getElementById('btn-main-book').classList.remove('hidden');
            document.getElementById('badge-status').classList.add('hidden');
            
            window.currentInstrumentData = { id: text }; // Reset current data

            loadBookings(text);
            try {
                const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'resources', text.replace(/\//g,'_')));
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    window.currentInstrumentData = data; // Save for modal footer
                    document.getElementById('item-title').innerText = data.description || text;
                    currentItemName = data.description;
                    if(data.isBookable === false) {
                        document.getElementById('btn-main-book').classList.add('hidden');
                        document.getElementById('badge-status').classList.remove('hidden');
                    }
                }
            } catch(e){}
        }
        
        function loadBookings(itemId) {
            const listEl = document.getElementById('bookings-list');
            listEl.innerHTML = '<p class="text-center text-xs text-slate-400">Caricamento...</p>';
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), where("resourceId", "==", itemId));
            onSnapshot(q, (snapshot) => {
                const bookings = [];
                snapshot.forEach(doc => bookings.push({ id: doc.id, ...doc.data() }));
                window.calendarBookingsCache = bookings;
                listEl.innerHTML = bookings.length ? `<p class="text-xs text-center text-slate-500">${bookings.length} prenotazioni future</p>` : '<p class="text-center text-xs text-slate-400">Nessuna prenotazione</p>';
            });
        }
        
        window.loadAdminBookings = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'));
            onSnapshot(q, (snapshot) => {
                const bookings = [];
                snapshot.forEach(doc => bookings.push({id: doc.id, ...doc.data()}));
                window.adminBookingsCache = bookings; 
                document.getElementById('admin-list').innerHTML = bookings.map(b => 
                    `<div class="bg-white p-2 border-b text-xs flex justify-between items-center">
                        <div>
                            <span>${b.resourceName || b.resourceId} - ${b.userName}</span>
                            <span class="text-slate-400 block text-[10px]">${new Date(b.startDate).toLocaleDateString()}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editBookingFromAdmin('${b.id}')" class="p-1 bg-amber-100 text-amber-700 rounded"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                            <button onclick="deleteBooking('${b.id}')" class="p-1 bg-red-100 text-red-600 rounded"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>`
                ).join('');
                lucide.createIcons();
            });
        }

        window.startScanner = async () => {
            document.getElementById('camera-overlay').classList.add('hidden');
            html5QrCode = new Html5Qrcode("reader");
            await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: {width:250, height:250} }, 
                (txt) => { if(html5QrCode) html5QrCode.stop(); currentItem=txt; showDetails(txt); });
        };
        window.stopScanner = async () => { if(html5QrCode) await html5QrCode.stop(); resetApp(); };

        window.openEditModal = (bookingObj = null) => {
            const booking = bookingObj || window.currentFoundBooking;
            if(!booking) return;
            editingBookingId = booking.id; 
            document.getElementById('modal-title').innerText = adminMode ? "Modifica (Admin)" : "Modifica Prenotazione";
            document.getElementById('btn-submit-booking').innerText = "SALVA MODIFICHE";
            document.getElementById('inp-name').value = booking.userName;
            const select = document.getElementById('inp-reason');
            const customInput = document.getElementById('inp-reason-custom');
            let isStandard = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === booking.reason) { isStandard = true; break; }
            }
            if(isStandard) { select.value = booking.reason; customInput.value = ""; } 
            else { select.value = "Altro"; customInput.value = booking.reason; }
            toggleCustomReason();
            document.getElementById('inp-start').value = booking.startDate;
            document.getElementById('inp-end').value = booking.endDate;
            document.getElementById('modal-booking').classList.remove('hidden');
            
            // Per le modifiche, usiamo il referente della prenotazione se salvato, o generico
            updateBookingFooter();
        };
        window.editBookingFromAdmin = (id) => {
            const booking = window.adminBookingsCache.find(b => b.id === id);
            if(booking) openEditModal(booking);
        };
        window.copyDirectLink = () => {
            const link = window.location.protocol + "//" + window.location.host + window.location.pathname + "?r=" + encodeURIComponent(currentItem);
            navigator.clipboard.writeText(link).then(() => alert("Link copiato negli appunti!"));
        };
        window.reportIssue = async () => {
            const issue = prompt("Descrivi il problema:");
            if(issue) alert("Segnalazione inviata (simulazione).");
        };
        window.openCalendarModal = () => {
            document.getElementById('modal-calendar').classList.remove('hidden');
            // Hide admin button for normal user
            document.getElementById('calendar-admin-actions').classList.add('hidden');
            renderCalendarTimeline();
        };
        window.openCalendarForInstrument = (id, name) => {
            currentItem = id;
            currentItemName = name;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), where("resourceId", "==", id));
            onSnapshot(q, (snapshot) => {
                const bookings = [];
                snapshot.forEach(doc => bookings.push({ id: doc.id, ...doc.data() }));
                window.calendarBookingsCache = bookings; 
                document.getElementById('modal-calendar').classList.remove('hidden');
                // Show admin button for admin flow
                document.getElementById('calendar-admin-actions').classList.remove('hidden');
                renderCalendarTimeline(name);
            });
        };
        function renderCalendarTimeline(titleOverride = null) {
            const container = document.getElementById('calendar-container');
            const bookings = window.calendarBookingsCache; 
            
            const title = titleOverride || currentItemName || currentItem;
            let html = `<h4 class="font-bold text-slate-700 mb-4 sticky top-0 bg-white pb-2 border-b">${title}</h4>`;
            
            const today = new Date();
            today.setHours(0,0,0,0);

            for(let i=0; i<7; i++) {
                const day = new Date(today);
                day.setDate(today.getDate() + i);
                
                const dayBookings = bookings.filter(b => {
                    const start = new Date(b.startDate);
                    const end = new Date(b.endDate);
                    return start.getDate() === day.getDate() && start.getMonth() === day.getMonth() || 
                           (start < day && end > day); 
                });

                let timelineHTML = '';
                if(dayBookings.length === 0) {
                     timelineHTML = `<div class="h-2 w-full bg-slate-100 rounded-full mt-2"></div>`;
                } else {
                    timelineHTML = `<div class="relative h-4 w-full bg-slate-100 rounded-full mt-2 overflow-hidden">`;
                    dayBookings.forEach(b => {
                        const s = new Date(b.startDate);
                        const e = new Date(b.endDate);
                        let startH = s.getHours() + s.getMinutes()/60;
                        let endH = e.getHours() + e.getMinutes()/60;
                        if(s.getDate() !== day.getDate()) startH = 0;
                        if(e.getDate() !== day.getDate()) endH = 24;
                        const left = (startH / 24) * 100;
                        const width = ((endH - startH) / 24) * 100;
                        timelineHTML += `<div class="absolute top-0 bottom-0 bg-indigo-600 border-r border-white" style="left:${left}%; width:${width}%;" title="${b.userName}"></div>`;
                    });
                    timelineHTML += `</div>`;
                }

                const dayName = day.toLocaleDateString('it-IT', {weekday:'short', day:'numeric', month:'short'});
                const isToday = i === 0;

                html += `
                    <div class="mb-4">
                        <div class="flex justify-between items-end">
                            <span class="text-xs font-bold ${isToday ? 'text-indigo-600' : 'text-slate-600'} uppercase">${isToday ? 'OGGI' : dayName}</span>
                            <span class="text-[10px] text-slate-400">00:00 - 24:00</span>
                        </div>
                        ${timelineHTML}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        lucide.createIcons();
    </script>
</body>
</html>